<link type="text/css" rel="stylesheet" href="/css/rating-star.css">
<section class="bg-primary">
  <h2 class="margin-top-1 margin-bottom-1 text-primary">Movie Profile</h2>
  <div style="width: 40%; float:left;">
    <img src="<%=@film.img_path %>" class="img_bio_film">
  </div>
  <div style="width: 60%; float:right; ">
    <div>
      <p class="highlight_text">Film name:</p>
      <%= @film.name %>
    </div>
    <div>
      <p class="highlight_text">Actors:</p>
      <% @actors.each do |actor| -%>
      <a href="/people/<%=actor.id%>" style="color: cadetblue"><%= actor.name %></a>
      <% end -%>
    </div>
    <div>
      <p class="highlight_text"> Released date:</p>
      <%= @film.released_date  %>
    </div>
    <div>
      <p class="highlight_text">Genre:</p>
      <% @genres.each do |genre| -%>
        <%= genre.name %> &nbsp &nbsp
      <% end -%>
    </div>
    <div style="width: 70%; float: left">
      <p class="highlight_text">Short description:</p>
      <p class = "bio_text"><%= @film.description %></p>
    </div>
    <div style="clear: both">
      <p class="highlight_text">Length:</p>
      <%= @film.length %> mins
    </div>
    <div style="clear: both">
      <p class="highlight_text">Mature rate:</p>
      <%= @film.mat_rate%>
    </div>
    <div style="clear: both">
      <p class="highlight_text">Rate Info:</p>
      <div id="rate_info">Rated <%= @avg_rate %> stars out of <%= @num_of_rates %> reviews.
      </div>
    </div>
    <div class="outter_box">
      <p id="rate_noti"></p>
      <div class="rate">
        <div id="1" class="btn-1 rate-btn"></div>
        <div id="2" class="btn-2 rate-btn"></div>
        <div id="3" class="btn-3 rate-btn"></div>
        <div id="4" class="btn-4 rate-btn"></div>
        <div id="5" class="btn-5 rate-btn"></div>
        <div id="6" class="btn-6 rate-btn"></div>
        <div id="7" class="btn-7 rate-btn"></div>
        <div id="8" class="btn-8 rate-btn"></div>
        <div id="9" class="btn-9 rate-btn"></div>
        <div id="10" class="btn-10 rate-btn"></div>
      </div>
    </div>
  </div>
  <div style="clear:both;">
    <div style="width: 40%; float:left;"></div>
    <div style="width: 60%; float:right;">
      <div id="comment_form">
        <div>
          <form action="/comment_submit">
            <div><textarea rows="3" name="comment" id="comment" placeholder="Comment"></textarea></div>
            <div><input type="button" name="submit" value="Add Comment" id="comment_btn"></div>
          </form>
        </div>
        <div id="all_comments">
          <% @comments.each do |comment| -%>
            <div class='friend'>
              <h5 class="commenter"><%=comment.commenter%></h5>
              <p class="comment_content"><%=comment.comment %></p>
            </div>
          <% end -%>
        </div>
      </div>
    </div>
  </div>
  <div style="width: 40%; clear:both">

  </div>
</section>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script>
    jQuery(document).ready(function () {
        var token = $('meta[name="csrf-token"]').attr('content');

        $.ajaxSetup({
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-CSRF-Token', token);
            }
        });
        var previous_rate = '<%=@pre_rate%>';
        console.log('previous_Rate ' + previous_rate)
        if (previous_rate > 0) {
            $("#rate_noti").html("<p>You rated this film "+previous_rate+" stars</p>");
            $('.rate-btn').removeClass('rate-btn-active');
            for (var i = previous_rate; i >= 0; i--) {
                $('.btn-' + i).addClass('rate-btn-active');
            }
            ;
        }
        else {
            $("#rate_noti").html("<p>You have not rated this film</p>");
        }

        $('.rate-btn').hover(function () {
            $('.rate-btn').removeClass('rate-btn-hover');
            var therate = $(this).attr('id');
            for (var i = therate; i >= 0; i--) {
                $('.btn-' + i).addClass('rate-btn-hover');
            }
            ;
        });
        $('.rate-btn').click(function () {
            var dataRate = "<%= @film.id %>";
            console.log("dataRate = " + dataRate);
            var therate = $(this).attr('id');
            $('.rate-btn').removeClass('rate-btn-active');
            for (var i = therate; i >= 0; i--) {
                $('.btn-' + i).addClass('rate-btn-active');
            }
            ;
            $.ajax(
                {
                    method: 'POST',
                    url: '/rate',
                    data: {
                        rate: 1,
                        film_id: dataRate,
                        rate_point: therate,
                    },
                    success: function (return_var) {
                        console.log("return var");
                        console.log(return_var);
                        if (return_var[0].command_code == 0) {
                            swal("Sorry!", "You need to login before rating this film!", "error");
                            // window.location.href = "/login"
                        }
                        else {
                            swal("Good job!", "Thank you for your rating!", "success");
                            $("#rate_info").html("<p>Rated " + return_var[0].avg_point + " stars out of " + return_var[0].rate_times + " reviews.</p>");
                            $("#rate_noti").html("<p>You rated this film " + therate + " stars</p>");
                            console.log(return_var);
                        }
                    },
                    dataType: 'Json',
                });
        });
        $("#comment_btn").click(function () {
            var comment_box = document.getElementById('comment').value;
            var film_id = <%=@film.id %>;
            if (comment_box.length < 20) {
                swal("Something's wrong!", "Comment should be more than 20 characters!", "warning");
            } else {
                $.ajax(
                    {
                        method: 'POST',
                        url: '/comment',
                        data: {
                            film_id: film_id,
                            comment: comment_box
                        },
                        success: function (comment_add) {
                            // console.log(comment_add)
                            if (comment_add['added'] == 0) {
                                swal("Sorry!", "You need to login before commenting this film!", "error");
                                // window.location.href = "/login"
                            }
                            else {
                                var all_comments = document.getElementById('all_comments');
                                var old_comments = all_comments.innerHTML;
                                var added_comment = "<div class='friend'>" +
                                    "                        <h5 class=\"commenter\">" + comment_add['user_name'] + "</h5>" +
                                    "                        <p class=\"comment_content\">" + comment_box + "</p>" +
                                    "                    </div>";
                                swal("Very good!", "Thank you for your comment!", "success");
                                all_comments.innerHTML = added_comment + old_comments;
                            }
                        },
                        dataType: 'Json',
                    }
                );
            }
        });
    })

</script>